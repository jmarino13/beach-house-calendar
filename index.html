<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beach House Calendar</title>

  <!-- FullCalendar (CSS + JS) -->
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js"></script>

  <!-- Supabase (UMD build exposes global `supabase`) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b1220; color:#eaf0ff; }
    header { padding: 16px 18px; border-bottom: 1px solid rgba(255,255,255,.12); display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 16px; padding: 14px; }
    input, select, button { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.25); color: #eaf0ff; }
    button { cursor:pointer; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    #calendar { margin-top: 14px; }
    .muted { opacity:.8; font-size: 13px; }
    .error { margin-top:10px; color:#ffb4b4; font-size:13px; }
  </style>
</head>

<body>
  <header>
    <div>
      <div style="font-weight:700;">Beach House Calendar</div>
      <div class="muted">Select dates to block off. Title shows the owner.</div>
    </div>
    <div class="row">
      <span id="authStatus" class="muted">Not signed in</span>
      <button id="signOutBtn" style="display:none;">Sign out</button>
    </div>
  </header>

  <div class="wrap">
    <div id="authCard" class="card">
      <div style="font-weight:700; margin-bottom:10px;">Sign in</div>
      <div class="row">
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
        <button id="loginBtn" type="button">Sign In</button>
      </div>
      <div id="loginError" class="error"></div>
      <div class="muted" style="margin-top:10px;">
        Enter your email and password to sign in.
      </div>
    </div>

    <div id="appCard" class="card" style="display:none;">
      <div class="row">
        <label class="muted">Owner name for new blocks:</label>
        <select id="ownerName">
          <option value="Owner 1">Owner 1</option>
          <option value="Owner 2">Owner 2</option>
        </select>
        <input id="notes" placeholder="Optional notes (cleaning, guests, etc.)" style="min-width:260px;" />
        <span class="muted">Tip: drag across days to block.</span>
      </div>
      <div id="calendar"></div>
      <div class="muted" style="margin-top:10px;">
        Click an existing block to delete it (only the creator can delete).
      </div>
    </div>
  </div>

<script>
  console.log("✅ beach-house-calendar script loaded");

  // Put your real values here (NO trailing slash)
  const SUPABASE_URL = "https://acbskcpmpxwnixwmbyfc.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjYnNrY3BtcHh3bml4d21ieWZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MTYzMzEsImV4cCI6MjA4NzA5MjMzMX0.06bOZQLhELsd5r67UU7FwO-hBHawoPaCIgx6bcZIXe4";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const authCard = document.getElementById("authCard");
  const appCard = document.getElementById("appCard");
  const authStatus = document.getElementById("authStatus");
  const signOutBtn = document.getElementById("signOutBtn");
  const loginError = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");

  console.log("✅ loginBtn found?", !!loginBtn);

  loginBtn.addEventListener("click", async () => {
    loginError.textContent = "Signing in...";

    const email = document.getElementById("email").value.trim().toLowerCase();
    const password = document.getElementById("password").value;

    try {
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      console.log("signInWithPassword:", { data, error });

      if (error) {
        loginError.textContent = "❌ " + error.message;
        return;
      }

      loginError.textContent = "";
      await refreshUI();
    } catch (e) {
      console.error("Login threw:", e);
      loginError.textContent = "❌ " + (e?.message || String(e));
    }
  });

  signOutBtn.addEventListener("click", async () => {
    await sb.auth.signOut();
    await refreshUI();
  });

  function toISODate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function addDaysISO(iso, days) {
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + days);
    return toISODate(d);
  }

  async function loadBlocks() {
    const { data, error } = await sb
      .from("blocks")
      .select("id,start_date,end_date,owner_name,notes,created_by");

    if (error) {
      alert(error.message);
      return [];
    }

    return (data || []).map(b => ({
      id: b.id,
      title: b.owner_name + (b.notes ? ` — ${b.notes}` : ""),
      start: b.start_date,
      end: addDaysISO(b.end_date, 1), // FullCalendar end is exclusive
      allDay: true
    }));
  }

  async function insertBlock(startISO, endExclusiveISO, ownerName, notes) {
    const inclusiveEnd = addDaysISO(endExclusiveISO, -1);
    const user = (await sb.auth.getUser()).data.user;
    if (!user) throw new Error("No logged-in user.");

    const { error } = await sb.from("blocks").insert({
      start_date: startISO,
      end_date: inclusiveEnd,
      owner_name: ownerName,
      notes: notes || null,
      created_by: user.id
    });

    if (error) throw error;
  }

  async function deleteBlock(id) {
    const { error } = await sb.from("blocks").delete().eq("id", id);
    if (error) throw error;
  }

  let calendar;

  async function initCalendar() {
    const el = document.getElementById("calendar");
    const events = await loadBlocks();

    calendar = new FullCalendar.Calendar(el, {
     plugins: [dayGridPlugin, interactionPlugin],
      initialView: "dayGridMonth",
      selectable: true,
      selectMirror: true,
      height: "auto",

      select: async (info) => {
        const owner = document.getElementById("ownerName").value;
        const notes = document.getElementById("notes").value.trim();

        try {
          await insertBlock(toISODate(info.start), toISODate(info.end), owner, notes);
        } catch (e) {
          const msg = (e?.message || "").toLowerCase();
          if (msg.includes("overlap") || msg.includes("exclude")) {
            alert("Those dates overlap with an existing block. Please pick different dates.");
          } else {
            alert(e.message || e);
          }
          return;
        }

        calendar.removeAllEvents();
        (await loadBlocks()).forEach(e => calendar.addEvent(e));
      },

      eventClick: async (info) => {
        if (!confirm("Delete this block?")) return;
        try {
          await deleteBlock(info.event.id);
          info.event.remove();
        } catch (e) {
          alert(e.message || e);
        }
      }
    });

    calendar.render();
    events.forEach(e => calendar.addEvent(e));
  }

  async function refreshUI() {
    const { data: { session } } = await sb.auth.getSession();
    console.log("session:", session);

    if (!session) {
      authCard.style.display = "block";
      appCard.style.display = "none";
      authStatus.textContent = "Not signed in";
      signOutBtn.style.display = "none";
      return;
    }

    authCard.style.display = "none";
    appCard.style.display = "block";
    authStatus.textContent = "Signed in";
    signOutBtn.style.display = "inline-block";

    if (!calendar) await initCalendar();
  }

  sb.auth.onAuthStateChange(() => refreshUI());
  refreshUI();
</script>

</body>
</html>
